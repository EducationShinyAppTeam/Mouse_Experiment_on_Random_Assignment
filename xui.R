library(shiny)
library(shinyjs)
library(shinyBS)
library(ggplot2)
library(V8)
library(shinydashboard)
library(shinyWidgets)


##Mouse app

#Use jscode to for reset button to reload the app
jsResetCode <- "shinyjs.reset = function() {history.go(0)}"


ui <- dashboardPage(skin = "black",
                    dashboardHeader(title = "Random Assignment",
                                    titleWidth = 195),
                    dashboardSidebar(width = 195,
                                     sidebarMenu(
                                       id = "tabs",
                                       menuItem("Overview", tabName = "instruction", icon = icon("dashboard")),
                                       menuItem("Generated by Hand", tabName = "hand", icon = icon("wpexplorer")),
                                       menuItem("Hand-Selected Data", tabName = "summary", icon = icon("wpexplorer")),
                                       menuItem("Generated by Computer", tabName = "computer", icon = icon("wpexplorer"))
                                     )
                    ),
                    dashboardBody(
                      tags$head(
                        tags$link(rel = "stylesheet", type = "text/css", href = "stylecssMouseExp.css")
                      ),
                      tabItems(
                        
                        tabItem(tabName = "instruction",
                                tags$a(href='http://stat.psu.edu/',tags$img(src='logo.png', align = "left", width = 180)),
                                br(),br(),br(),
                                h3(strong("About:")),
                                h4("This app is designed to help you see the benefit in terms of reduced bias when random assignment is used instead of haphazard assignment to treatment groups. 
       The app also demonstrates the distribution of averages and proportions when random assignment is used."),br(),
                                h3(strong("Instructions:")), 
                                h4(tags$li("Raspberries have a high content of many beneficial compounds like vitamins C and E, folic and ellagic acid, calcium, selenium, etc. As a result, researchers have recently been investigating
                                          their anti-cancer properties. All of the twenty mice in the picture have a tumor growing just under the skin on their backs. To test if raspberries can help reduce the growth of these tumors,
          ten mice will be chosen to have raspberries added in their diet and the remaining ten will eat a normal diet without the raspberries.")),
                                h4(tags$li("Please pick the ten mice that will receive the raspberry diet (quickly click on mice you want to include in the raspberry group until you have selected ten, then click the submit selections button).")),
                                h4(tags$li("If you select more than 10 mice, please click RESET to select again.")),
                                h4(tags$li("Click RAW DATA to copy the data if you need to do further analysis.")),
                                div(style = "text-align: center",
                                    bsButton("go","Go",icon("bolt"),style = "danger",size = "large",class="circle grow")),
                                br(),
                                h3(strong("Acknowledgements:")),
                                h4("This app was developed and coded by Yuxin Zhang and update by Luxin Wang and Thomas McIntyre based on extending the idea in the", tags$a(href = "https://www.causeweb.org/cause/archive/mouse_experiment/","app by Dennis Pearl and Tom Santner", style = "text-decoration: underline; color: #CC3333"),".")
                                
                        ),
                        tabItem(tabName = "hand",
                                fluidPage(
                                  div(style="display: inline-block;vertical-align:top;",
                                      tags$a(href='https://shinyapps.science.psu.edu/',tags$img(src='homebut.PNG', width = 19))
                                  ),
                                  div(style="display: inline-block;vertical-align:top;",
                                      circleButton("info",icon = icon("info"), status = "myClass",size = "xs")
                                  ),
                                  
                                  #Use jscode to for reset button to reload the app
                                  useShinyjs(),
                                  extendShinyjs(text = jsResetCode),
                                  #Use jscode to disable all the buttons
                                  tags$head(tags$script(HTML('
                                                             Shiny.addCustomMessageHandler("jsCode",
                                                             function(message) {
                                                             console.log(message)
                                                             eval(message.code);
                                                             }
                                                             );
                                                             '))),
                                  
                                  titlePanel(h2("Please choose 10 Mice for the Raspberry Treatment")),
                                  br(),
                                  #Display all the mice in main panel
                                  fluidRow( column(1, bsButton("btn1",type='action',label = tags$img(src = 'brown3.png',width = 82))),
                                            div(style = "position: relative; left: 50px;",column(3, offset = 1, bsButton("btn18",label = tags$img(src='brown3.png', width = 142)))),
                                            column(2, bsButton("btn3",label = tags$img(src='black3.png', width = 90,disabled=TRUE))),
                                            column(4, bsButton("btn4",label = tags$img(src='black3.png', width = 90,disabled=TRUE)))),
                                  
                                  fluidRow( 
                                    div(style = "position: relative; left: -20px; top: 3px",column(2, bsButton("btn6",label = tags$img(src='brown3.png', width = 97)))),
                                    div(style = "position: relative; left: 20px; top: 15px",column(5, bsButton("btn20",label = tags$img(src='black3.png', width = 162)))),
                                    div(style = "position: relative; left: 80px; top: -60px",column(2, bsButton("btn5",label = tags$img(src='brown3.png', width = 95)))),
                                    div(style = "position: relative; left: 40px; top: -40px",column(1, bsButton("btn8",label = tags$img(src='black3.png', width = 92)))),
                                    #div(style = "position: relative; left: -200px; top: -5px",
                                    column(4, bsButton("btn10",label = tags$img(src='black3.png', width = 101))),
                                    div(style = "position: relative; left: 0px; top: 12px",column(2, bsButton("btn7",label = tags$img(src='brown3.png', width = 101)))),
                                    div(style = "position: relative; left: 0px; top: 12px",column(2, bsButton("btn11",label = tags$img(src='brown3.png', width = 102)))),
                                    div(style = "position: relative; top: -50px", column(2, bsButton("btn12",label = tags$img(src='brown3.png', width = 113)))),
                                    div(style = "position: relative; top: 20px; left: 40px;", column(2, bsButton("btn13",label = tags$img(src='black3.png', width = 122)))),
                                    div(style = "position: relative; top: -15px; left: 30px;", column(2, bsButton("btn14",label = tags$img(src='brown3.png', width = 124)))),
                                    div(style = "position: relative; top: 90px; left: -100px;", column(2, bsButton("btn15",label = tags$img(src='brown3.png', width = 126)))),
                                    div(style = "position: relative; top: 20px; left: -100px;", column(2, bsButton("btn16",label = tags$img(src='black3.png', width = 126)))),
                                    div(style = "position: relative; top: 80px; left: -150px;", column(2, bsButton("btn17",label = tags$img(src='brown3.png', width = 127)))),
                                    div(style = "position: relative; top: -20px; left: 0px;", column(2, bsButton("btn19",label = tags$img(src='black3.png', width = 154)))) 
                                    # div(style = "position: relative; left: 10px; top: 10px;",
                                    #     bsButton("btn2",label = tags$img(src='brown3.png', width = 84))),
                                    # bsButton("btn9",label = tags$img(src='black3.png', width = 101)),
                                    # bsButton("btn2",label = tags$img(src='brown3.png', width = 84))
                                  ),br(),br(),br(),br(),br(),br(),br(),br(),
                                  fluidRow(
                                    bsButton("btn9",label = tags$img(src='black3.png', width = 101)),
                                    bsButton("btn2",label = tags$img(src='brown3.png', width = 84))
                                  ),
                                  
                                  br(),hr(),
                                  fluidRow(
                                    column(3,h3("You have selected")),
                                    column(1,textOutput("number")),
                                    column(1,h3("mice"))
                                  ),
                                  fluidRow(
                                    column(2,offset = 1, bsButton("reset_button", "Reset", style = "danger", icon = icon("refresh"), size = "large")),
                                    bsPopover("reset_button",title = "Notice", "Click Reset to start again.", placement = "top"),
                                    column(2,bsButton("submit","Submit Selection", style = "danger",icon = icon("hand-o-up"), size = "large", disabled = TRUE))),
                                  hr()
                                  
                                  
                                  
                                  )
                                  ),
                        tabItem(tabName = "summary",
                                fluidPage(
                                  div(style="display: inline-block;vertical-align:top;",
                                      tags$a(href='https://shinyapps.science.psu.edu/',tags$img(src='homebut.PNG', width = 19))
                                  ),
                                  div(style = "position:relative; left: 30px;", fluidRow(h2("Summary of the mice Hand-Selected for Comparison:"))),br(),br(),br(),
                                  conditionalPanel(
                                    condition = "input.submit == 0",
                                    fluidPage(
                                      wellPanel(div(style = "position: relative; text-align: center;", icon("lock"), h3("Please choose 10 mice to unlock this page.")))
                                    )
                                  ),
                                  conditionalPanel(
                                    condition = "(output.number >= 10)&(input.submit != 0)",
                                    fluidPage(
                                      
                                      fluidRow(column(12,
                                                      wellPanel(
                                                        fluidRow(
                                                          column(2,""), column(2,"Total selected"), column(2,"Average Weight (g)"), column(2,"Average Age (wks)"), column(2,"Average Tumor Mass (mg)"), column(1,"Proportion Female"), column(1,"Proportion Brown")
                                                        ), 
                                                        fluidRow(
                                                          column(2,"Rspb.Group"), column(2,"10"), column(2,textOutput("aveWeight")), column(2,textOutput("aveAge")), column(2,textOutput("aveTu")), column(1,textOutput("gend")), column(1,textOutput("col"))
                                                        ),
                                                        fluidRow(
                                                          column(2,"Control Group"), column(2,"10"), column(2,textOutput("aveWeightC")), column(2,textOutput("aveAgeC")), column(2,textOutput("aveTuC")), column(1,textOutput("gendC")), column(1,textOutput("colC"))
                                                        )
                                                      )
                                      )
                                      ),
                                      fluidRow(
                                        div(style = "position:relative; left:-10px;", column(3,plotOutput("weight"))), column(3,plotOutput("age")), column(6,plotOutput("tumor")) 
                                      ),
                                      fluidRow(
                                        div(style = "position:relative; left:-10px;", column(3,plotOutput("gender"))), column(3,plotOutput("color")),
                                        div(style = "position:relative; left:50px;", column(6, div(style = "position:absolute; top: 3em; left: 10px",
                                                                                                   sliderInput("theta", 
                                                                                                               label = div(style='width: 400px;', 
                                                                                                                           div(style='float:left;', 'No Treatment Effect'), 
                                                                                                                           div(style='float:right;', 'Treatment Effect In Real Experiment')), 
                                                                                                               min = 0, max = 1, value = 0.6, width = '90%'))))
                                      ), br(), br(), br(), br(), br(),
                                      fluidRow(div(style = "position:relative; left: 60px; top: 240px", bsButton("compare","Compare with Random Selection", style = "danger")),
                                               div(style = "position:relative; left: 60px; top: 100px", bsButton("getdata","Use Raw Data", style = "danger"))
                                               
                                      )), conditionalPanel("input.getdata != 0", verbatimTextOutput("dataf"))
                                    
                                  )
                                )),
                        tabItem(tabName = "computer",
                                fluidPage(
                                  div(style="display: inline-block;vertical-align:top;",
                                      tags$a(href='https://shinyapps.science.psu.edu/',tags$img(src='homebut.PNG', width = 19))
                                  ),
                                  wellPanel(
                                    fluidRow(
                                      column(2,numericInput("times", label = NULL, value = 1, min = 1)),
                                      column(9,h4("Enter number to run multiple trials. (Hint: Try entering 10, 100, 1000, etc.)"))
                                    )
                                  ),
                                  conditionalPanel(
                                    condition = "input.times < 1",
                                    fluidPage(
                                      wellPanel(div(style = "position: relative; text-align: center;", icon("lock"), 
                                                    h3("Warning: The input number has to be at least one.")))
                                    )
                                  ),
                                  conditionalPanel(
                                    condition = "input.times >= 1",
                                    fluidRow(
                                      column(6, tableOutput("computerTable")),
                                      column(6, sliderInput("compTheta", 
                                                            label = div(style='width:400px;', 
                                                                        div(style='float:left;', 'No Treatment Effect'), 
                                                                        div(style='float:right;', 'Treatment Effect In Real Experiment')), 
                                                            min = 0, max = 1, value = 0.6, width = '400px'))
                                    ), br(), br(), br(), br(), br(), br(), br(),
                                    fluidRow(
                                      column(3,plotOutput("compWeightBar")), column(3,plotOutput("compAgeBar")), column(6,plotOutput("compTumorBar"))
                                    ),
                                    fluidRow(
                                      column(4,plotOutput("compWeightHist")), column(4,plotOutput("compAgeHist")), column(4,plotOutput("compTumorHist"))
                                    ),
                                    fluidRow(
                                      div(style = "position:relative; top: -35px;", bsButton("compGetdata","Use the data from last trial", style = "danger"))
                                    )
                                    , conditionalPanel("input.compGetdata != 0", 
                                                       column(6,verbatimTextOutput("compDataf"))
                                    )
                                  )
                                  
                                )
                        )
                                )
                        )
                      )

