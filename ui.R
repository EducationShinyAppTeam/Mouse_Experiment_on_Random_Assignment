library(shiny)
library(shinyjs)
library(shinyBS)
library(ggplot2)
library(V8)
library(shinydashboard)
library(shinyWidgets)
library(boastUtils)

##Mouse app

#Use jscode to for reset button to reload the app
jsResetCode <- "shinyjs.reset = function() {history.go(0)}"


ui <- list(
    tags$head(
      tags$link(
        rel = "stylesheet",
        type = "text/css",
        href = "https://educationshinyappteam.github.io/Style_Guide/theme/boast.css")
    ),
    dashboardPage(
      skin = "red",
      dashboardHeader(
        title = "Random Assignment",
        titleWidth = 250,
        tags$li(class = "dropdown", actionLink("info", icon("info"))),
        tags$li(class = "dropdown",
                tags$a(href='https://shinyapps.science.psu.edu/',
                       icon("home")))
      ),
      dashboardSidebar(
        width = 250,
        sidebarMenu(
          id = "tabs",
          menuItem("Overview", tabName = "overview", icon = icon("dashboard")),
          menuItem("Generated by Hand", tabName = "hand", icon = icon("wpexplorer")),
          menuItem("Hand-Selected Data", tabName = "summary", icon = icon("wpexplorer")),
          menuItem("Generated by Computer", tabName = "computer", icon = icon("wpexplorer")),
          menuItem("References", tabName = "references", icon = icon("leanpub"))
        ),
        tags$div(
          class = "sidebar-logo",
          boastUtils::psu_eberly_logo("reversed")
        )
      ),
      dashboardBody(
        # tags$head(
        #   tags$link(rel = "stylesheet", type = "text/css", href = "stylecssMouseExp.css")
        # ),
        tabItems(
          tabItem(
            tabName = "overview",
            h1("Mouse Experiment on Random Assignment"),
            p("This app is designed to help you see the benefit in terms of 
            reduced bias when random assignment is used instead of haphazard 
            assignment to treatment groups. The app also demonstrates the
            distribution of averages and proportions when random assignment 
            is used."),br(),
            p("Raspberries have a high content of many beneficial compounds
                like vitamins C and E, folic and ellagic acid, calcium, selenium, etc.
                As a result, researchers have recently been investigating their 
                anti-cancer properties. All of the twenty mice in the picture have a 
                tumor growing just under the skin on their backs. To test if raspberries 
                can help reduce the growth of these tumors, ten mice will be chosen to 
                have raspberries added in their diet and the remaining ten will 
                eat a normal diet without the raspberries."),
            h2("Instructions"), 
            tags$ul(
              tags$li("Please pick the ten mice that will receive the raspberry diet 
                    (quickly click on mice you want to include in the raspberry group 
                    until you have selected ten, then click the submit selections button)."),
              tags$li("If you select more than 10 mice, please click RESET to select again."),
              tags$li("Click RAW DATA to copy the data if you need to do further analysis."),
              tags$li(strong("Note:"), "This app is intended to be used in full screen mode.")
          ),
          div(
            style = "text-align: center",
            bsButton(
              inputId = "go",
              label = "Go",
              icon = icon("bolt"),
              size = "large",
              class="circle grow"
            )
          ),
          br(),
          h2("Acknowledgements"),
          p("This app was oringinally developed and coded by Yuxin Zhang and update by Luxin 
            Wang and Thomas McIntyre based on extending the idea in the", 
            tags$a(href = "https://www.causeweb.org/cause/archive/mouse_experiment/",
                  "app by Dennis Pearl and Tom Santner", class = "bodylinks"),". The current version 
                  of the app was modified by Chenese Gray."),
          div(class = "updated", "Last Update: 07/16/20 by C.G.")
          ),
          tabItem(
            tabName = "hand",
            fluidPage(
              #Use jscode to for reset button to reload the app
              useShinyjs(),
              extendShinyjs(text = jsResetCode),
              #Use jscode to disable all the buttons
              tags$head(
                tags$script
                  (HTML('Shiny.addCustomMessageHandler("jsCode",
                        function(message) {console.log(message)
                        eval(message.code);};'))),
              h2("Please choose 10 Mice for the Raspberry Treatment"),
              br(),
              #Display all the mice in main panel
              fluidRow(
                column(2, offset = 1, bsButton("btn1",type='action',label = tags$img(src = 'brown3.png',width = 82))),
                column(3, bsButton("btn18",label = tags$img(src='brown3.png', width = 142))),
                column(3, bsButton("btn3",label = tags$img(src='black3.png', width = 90,disabled=TRUE))),
                column(3, bsButton("btn4",label = tags$img(src='black3.png', width = 90,disabled=TRUE)))
                ),br(),br(),
              fluidRow(
                column(2, bsButton("btn6",label = tags$img(src='brown3.png', width = 97))),
                column(3, offset = 1, bsButton("btn20",label = tags$img(src='black3.png', width = 162))),
                column(3, offset = 1, bsButton("btn5",label = tags$img(src='brown3.png', width = 95))),
                column(2, bsButton("btn8",label = tags$img(src='black3.png', width = 92)))
                       ),br(),br(),
              fluidRow(
                column(2, offset = 1, bsButton("btn10",label = tags$img(src='black3.png', width = 101))),
                column(3, offset = 1, bsButton("btn7",label = tags$img(src='brown3.png', width = 101))),
                column(2, bsButton("btn11",label = tags$img(src='brown3.png', width = 102))),
                column(2, bsButton("btn12",label = tags$img(src='brown3.png', width = 113)))
              ),br(),br(),
              
              fluidRow( 
                column(3, bsButton("btn13",label = tags$img(src='black3.png', width = 122))),
                column(2, bsButton("btn14",label = tags$img(src='brown3.png', width = 124))),
                column(3, bsButton("btn15",label = tags$img(src='brown3.png', width = 126))),
                column(3, bsButton("btn16",label = tags$img(src='black3.png', width = 126))),
                
                # div(style = "position: relative; left: 10px; top: 10px;",
                #     bsButton("btn2",label = tags$img(src='brown3.png', width = 84))),
                # bsButton("btn9",label = tags$img(src='black3.png', width = 101)),
                # bsButton("btn2",label = tags$img(src='brown3.png', width = 84))
              ),br(),br(),
              fluidRow(
                column(2, offset = 1, bsButton("btn17",label = tags$img(src='brown3.png', width = 127))),
                column(2, offset = 1, bsButton("btn19",label = tags$img(src='black3.png', width = 154))), 
                column(3, offset = 1, bsButton("btn9",label = tags$img(src='black3.png', width = 101))),
                column(2, bsButton("btn2",label = tags$img(src='brown3.png', width = 84)))
              ),
              br(),hr(),
              fluidRow(
                column(3,h3("You have selected")),
                column(1,textOutput("number")),
                column(1,h3("mice"))
              ),
              fluidRow(
                column(2,offset = 1, bsButton("reset_button", "Reset", icon = icon("refresh"), size = "large")),
                bsPopover("reset_button",title = "Notice", "Click Reset to start again.", placement = "top"),
                column(2,bsButton("submit","Submit Selection",icon = icon("hand-o-up"), size = "large", disabled = TRUE))),
                hr()
            )
          ),
          tabItem(
            tabName = "summary",
            fluidPage(
              div(
                style = "position:relative; left: 30px;",
                fluidRow(h2("Summary of Hand-Selected  for Comparison:"))
              ),
              br(),br(),br(),
              conditionalPanel(
                condition = "input.submit == 0",
                fluidPage(
                  wellPanel(div(style = "position: relative; text-align: center;", icon("lock"), h3("Please choose 10 mice to unlock this page.")))
                )
              ),
              conditionalPanel(
                condition = "(output.number >= 10)&(input.submit != 0)",
                fluidPage(
                  fluidRow(
                    column(
                      width = 12, 
                      wellPanel(
                        fluidRow(
                           column(2,""), 
                           column(2,"Total selected"), 
                           column(2,"Average Weight (g)"), 
                           column(2,"Average Age (wks)"), 
                           column(2,"Average Tumor Mass (mg)"), 
                           column(1,"Proportion Female"), 
                           column(1,"Proportion Brown")
                          ), 
                          fluidRow(
                            column(2,"Rspb.Group"), 
                            column(2,"10"), 
                            column(2,textOutput("aveWeight")), 
                            column(2,textOutput("aveAge")), 
                            column(2,textOutput("aveTu")), 
                            column(1,textOutput("gend")), 
                            column(1,textOutput("col"))
                          ),
                          fluidRow(
                            column(2,"Control Group"), 
                            column(2,"10"), 
                            column(2,textOutput("aveWeightC")), 
                            column(2,textOutput("aveAgeC")), 
                            column(2,textOutput("aveTuC")), 
                            column(1,textOutput("gendC")), 
                            column(1,textOutput("colC"))
                        )
                      )
                    )
                  ),
                  fluidRow(
                     column(3,plotOutput("weight")), 
                     column(3,plotOutput("age")), 
                     column(6,plotOutput("tumor")) 
                  ),
                  fluidRow(
                      column(3,plotOutput("gender")), 
                      column(3,plotOutput("color")),
                    
                      column(
                        width = 6, 
                        
                          sliderInput(
                            "theta", 
                            label = fluidRow(column(3,"No Treatment Effect"), column(3, offset = 6, "Treatment Effect In Real Experiment")),   
                            min = 0, 
                            max = 1, 
                            value = 0.6, 
                            width = '90%'
                          )
                        
                      )
                    
                  ), 
                  br(), br(), br(),
                  fluidRow(
                    column(4, offset = 2,
                           bsButton("getdata","Use Raw Data")
                    ),
                    column(4,
                      bsButton("compare","Compare with Random Selection")
                    )
                  )
                ), 
                conditionalPanel("input.getdata != 0", verbatimTextOutput("dataf"))
              )
            )
          ),
          tabItem(
            tabName = "computer",
            fluidPage(
              wellPanel(
                fluidRow(
                  column(2,numericInput("times", label = NULL, value = 1, min = 1)),
                  column(9,h4("Enter number to run multiple trials. (Hint: Try entering 10, 100, 1000, etc.)"))
                )
              ),
              conditionalPanel(
                condition = "input.times < 1",
                fluidPage(
                  wellPanel(
                    div(
                      style = "position: relative; text-align: center;", icon("lock"), 
                      p("Warning: The input number has to be at least one.")))
                )
              ),
              conditionalPanel(
                condition = "input.times >= 1",
                fluidRow(
                  column(6, tableOutput("computerTable")),
                  column(
                    width = 6, 
                    sliderInput(
                      "compTheta", 
                      label = fluidRow(column(3,"No Treatment Effect"), column(3, offset = 6, "Treatment Effect In Real Experiment")),
                      min = 0, 
                      max = 1, 
                      value = 0.6, 
                      width = '400px'
                    )
                  )
                ), 
                br(), br(), br(), br(), br(), br(), br(),
                fluidRow(
                  column(3,plotOutput("compWeightBar")), column(3,plotOutput("compAgeBar")), column(6,plotOutput("compTumorBar"))
                ),
                fluidRow(
                  column(4,plotOutput("compWeightHist")), column(4,plotOutput("compAgeHist")), column(4,plotOutput("compTumorHist"))
                ),
                fluidRow(
                  div(style = "position:relative; top: -35px;", bsButton("compGetdata","Use the data from last trial"))
                ), 
                conditionalPanel(
                  condtion = "input.compGetdata != 0", 
                  column(6,verbatimTextOutput("compDataf"))
                )
              )
            )
          ),
          tabItem(
            tabName = "references", 
            h2("References"),
            p(
              class = "hangingindent",
              "Attali, D. (2020). shinyjs: Easily Improve the User Experience of 
              Your Shiny Apps in Seconds. R package version 1.1. Available from 
              https://CRAN.R-project.org/package=shinyjs"
            ),
            p(
              class = "haningindent",
              "Bailey, E. (2015). shinyBS: Twitter Bootstrap Components for Shiny. 
               R package version 0.61. Available from https://CRAN.R-project.org/package=shinyBS"
            ),
            p(
              class = "hangingindent",
              "Carey, R. and Hatfield, N. (2020). boastUtils: BOAST Utilities. R 
              package version 0.1.6.1. Available from https://github.com/EducationShinyAppTeam/boastUtils"
            ),
            p(
              class = "hangingindent",
              "Chang, W. and Borges Ribeiro, B. (2018). shinydashboard: Create 
              Dashboards with 'Shiny'. R package version 0.7.1. Available from 
              https://CRAN.R-project.org/package=shinydashboard"
            ),
            p(
              class = "hangingindent", 
              "Chang, W., Cheng, J., Allaire, J., Xie, Y., and McPherson, J. (2020). 
              shiny: Web Application Framework for R. R package version 1.5.0. Available 
              from https://CRAN.R-project.org/package=shiny"
            ),
            p(
              class = "hangingindent", 
              "Ooms, J. (2020). V8: Embedded JavaScript and WebAssembly Engine 
              for R. R package version 3.0.2. Available from https://CRAN.R-project.org/package=V8"
            ),
            p(
              class = "hangingindent",
              "Perrier, V., Meyer, F. and Granjon, D. (2020). shinyWidgets: Custom 
              Inputs Widgets for Shiny. R package version 0.5.2. Available from 
              https://CRAN.R-project.org/package=shinyWidgets"
            ),
            p(
              class = "hangingindent", 
              "Wickham, H. ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag 
              New York, 2016."
            )
          )
        )
      )
    )
  )
